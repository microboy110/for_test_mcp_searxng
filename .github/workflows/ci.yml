# .github/workflows/ci.yml â€”â€” å¢å¼ºç‰ˆï¼šæ”¯æŒæ‰‹åŠ¨è§¦å‘ + CI/CD
name: MCP Server CI/CD

# è§¦å‘æ¡ä»¶ï¼špush / PR / æ‰‹åŠ¨è§¦å‘
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # â­ æ–°å¢ï¼šå…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      environment:
        description: 'Deploy environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - dev
          - staging
          - prod
      deploy:
        description: 'Trigger deployment to Zeabur?'
        required: true
        default: 'false'
        type: boolean
      branch:
        description: 'Branch to deploy (optional, defaults to main)'
        required: false
        default: 'main'

# å…¨å±€å˜é‡ï¼šé¿å…é‡å¤å®šä¹‰
env:
  PYTHON_VERSION: '3.11'
  SEARXNG_URL: ${{ secrets.SEARXNG_URL || 'https://searxng.example.com' }}

jobs:
  ci-checks:
    name: ğŸ§ª CI Checks (Test/Lint)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --no-cache-dir flake8 pytest pytest-asyncio
          pip install --no-cache-dir fastapi uvicorn httpx pydantic

      - name: Run Lint (flake8)
        run: |
          flake8 main.py --count --show-source --statistics --max-line-length=120

      - name: Check imports are valid
        run: |
          python -c "from main import app; print('âœ… Imports OK')"

      - name: Run fastapi test (basic)
        run: |
          python -c "
          import asyncio
          from main import app, perform_search, SearchRequest
          print('âœ… FastAPI app instance created')
          req = SearchRequest(query='test')
          print(f'âœ… Sample request: {req.query}')
          print(f'âœ… SearXNG URL: {app.get(\'SEARXNG_URL\') or \'not loaded yet\' if isinstance(app, dict) else \'OK\'}')
          "

      - name: Run pytest (if tests added later)
        run: |
          # placeholder â€” add `pytest tests/` when tests added
          echo 'No tests yet â€” add tests/ later'

  build-and-push:
    name: ğŸ³ Docker Build & Push (Optional)
    needs: ci-checks
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write  # âš ï¸ å…è®¸.push to GitHub Container Registry (ghcr.io)
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  deploy-zeabur:
    name: â˜ï¸ Deploy to Zeabur (Manual)
    needs: [ ci-checks, build-and-push ]
    if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.deploy == 'true' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Zeabur CLI
        run: npm install -g @zeabur/cli

      - name: Configure Zeabur
        run: |
          zeabur login --token ${{ secrets.ZEABUR_TOKEN }}
          echo "âœ… Zeabur configured"

      - name: Deploy to Zeabur
        env:
          SEARXNG_URL: ${{ env.SEARXNG_URL }}
        run: |
          # æ³¨æ„ï¼šè¿™é‡Œéœ€è¦é¢„å…ˆåˆ›å»ºæœåŠ¡ï¼Œå¹¶è®°å½• service åç§°
          # ç¤ºä¾‹ï¼šzeabur services create --dir ./ --name [your-service-name]
          # å¦‚æœæœåŠ¡å·²å­˜åœ¨ï¼Œå¯ç›´æ¥ zeabur deploy
          ZEABUR_SERVICE_NAME="${{ secrets.ZEABUR_SERVICE_NAME }}"

          if [ -z "$ZEABUR_SERVICE_NAME" ]; then
            echo "âŒ Error: SEABUR_SERVICE_NAME secret is not set"
            exit 1
          fi

          zeabur deploy --service "$ZEABUR_SERVICE_NAME"
          echo "âœ… Deployed to environment: ${{ github.event.inputs.environment }}"
